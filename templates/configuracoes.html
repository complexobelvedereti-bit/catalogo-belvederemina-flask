<!DOCTYPE html>
<html>
<head>
    <title>Configura√ß√µes do Cat√°logo</title>
    <style>
        /* [ ... C√ìDIGO CSS EXISTENTE ... ] */
        body { 
            font-family: Arial, sans-serif; 
            margin: 40px; 
            padding-bottom: 100px; 
        }
        h1 { color: #333; text-align: center; }
        
        .save-fixed-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa;
            border-top: 1px solid #ccc;
            padding: 15px 40px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000; 
        }

        .save-fixed-container button.main-save-btn {
            width: 300px; 
            max-width: 100%; 
            margin: 0 auto;
            display: block;
            padding: 15px 25px; 
            font-size: 1.1em;
            background-color: #007bff; 
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        .nav-links { margin-bottom: 20px; display: block; overflow: auto; border-bottom: 2px solid #ccc; padding-bottom: 15px; }
        .nav-links a { 
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: bold;
            margin-right: 10px;
            float: left;
        }
        .back-link { background-color: #6c757d; color: white; }
        .logout-link { background-color: #dc3545; color: white; float: right; }

        .action-form-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            flex-wrap: wrap; 
        }
        .action-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex: 1 1 300px; 
        }
        .action-form h3 {
            margin-top: 0;
            color: #007bff;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .action-form input[type="text"], .action-form select, 
        .action-form input[type="number"] {
            width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;
        }
        .action-form button {
            width: 100%; background-color: #28a745; color: white; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }

        /* Bot√µes de Mover */
        .move-btn-container { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
            width: 30px;
        }
        .move-link {
            text-decoration: none;
            display: inline-block;
            text-align: center;
            border: 1px solid #ccc;
            padding: 5px;
            cursor: pointer;
            border-radius: 3px;
            font-weight: bold;
            line-height: 1;
            color: #333; 
        }
        .move-link:hover {
            background-color: #f0f0f0;
        }
        .cat-link {
            color: blue !important; 
            font-size: 1.2em;
        }
        
        /* Estilos da Tabela Principal de Edi√ß√£o */
        .category-table { width: 100%; border-collapse: collapse; margin-bottom: 40px; }
        .category-header { background-color: #f8d7da; color: #721c24; font-weight: bold; text-align: center; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .category-table input[type="text"], .category-table input[type="number"] { width: 100%; padding: 5px; box-sizing: border-box; }

        /* NOVO CSS: Bot√µes de Exclus√£o */
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 8px;
            border-radius: 3px;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.8em;
            font-weight: bold;
            transition: background-color 0.2s;
            margin-left: 10px;
        }
        .delete-btn:hover {
            background-color: #c82333;
        }
        .delete-item-cell {
    /* üõë ATUALIZADO: Alinha o bot√£o 'X' vertical e horizontalmente */
    display: flex;
    justify-content: center; /* Centraliza horizontalmente */
    align-items: center;     /* Centraliza verticalmente */
    
    width: 80px; 
    /* Adiciona padding para que a c√©lula tenha a mesma altura que as demais (com inputs) */
    padding: 30px 5px !important; 
}
        
        /* Media Query para Mobile */
        @media (max-width: 768px) {
            .action-form-container { flex-direction: column; }
            body { margin: 15px; padding-bottom: 90px; } 
            .nav-links a { display: none !important; }
            .action-form { margin-bottom: 15px; }
            h1 { font-size: 1.5em; }
            .save-fixed-container { padding: 10px 15px; }
        }
    </style>
</head>
<body>
    
    <div class="nav-links">
        <a href="{{ url_for('index') }}" class="back-link">‚Üê Ver Cat√°logo</a>
        <a href="{{ url_for('logout') }}" class="logout-link">Sair</a>
    </div>

    <h1>Configura√ß√µes e Edi√ß√£o de Produtos</h1>

    <div class="action-form-container">

        <div class="action-form">
            <h3>Adicionar Nova Categoria</h3>
            <form method="POST" action="{{ url_for('configuracoes') }}" id="add-category-form">
                <input type="hidden" name="action" value="add_category">
                <input type="text" name="new_category_name" placeholder="Nome da Categoria" required>
                <button type="submit">Criar Categoria</button>
            </form>
        </div>

        <div class="action-form">
            <h3>Adicionar Novo Item</h3>
            <form method="POST" action="{{ url_for('configuracoes') }}" id="add-item-form">
                <input type="hidden" name="action" value="add_item">
                
                <select name="target_category" required>
                    <option value="">-- Selecione a Categoria --</option>
                    {% for categoria, produtos in cardapio.items() %}
                        <option value="{{ categoria }}">{{ categoria | replace('_', ' ') | title }}</option>
                    {% endfor %}
                </select>

                <input type="text" name="item_name" placeholder="Nome do Item" required>
                <input type="text" name="item_description" placeholder="Descri√ß√£o (opcional)">
                <input type="number" step="0.01" name="item_value" placeholder="Valor (Ex: 35.00)" required>

                <button type="submit">Adicionar Item</button>
            </form>
        </div>
    </div>
    <h2>Editar, Mover e Salvar Itens</h2>
    
    <form method="POST" action="{{ url_for('configuracoes') }}" id="main-edit-form">
        <input type="hidden" name="action" value="edit_existing">
        
        {% for categoria, produtos in cardapio.items() %}
        
        <table class="category-table" id="{{ categoria }}">
            <thead>
                <tr>
                    <th colspan="5" class="category-header">
                        <span>{{ categoria | replace('_', ' ') | title }}</span>
                        <div style="display: flex; gap: 5px;">
                            <a href="{{ url_for('move_category_action', category_key=categoria, direction='up') }}" class="move-link cat-link move-action">‚ñ≤</a>
                            <a href="{{ url_for('move_category_action', category_key=categoria, direction='down') }}" class="move-link cat-link move-action">‚ñº</a>
                            
                            <a href="{{ url_for('delete_category', category_key=categoria) }}" 
                               class="delete-btn delete-category-action" 
                               data-category-name="{{ categoria | replace('_', ' ') | title }}">
                               EXCLUIR
                            </a>
                        </div>
                    </th>
                </tr>
                <tr>
                    <th style="width: 5%;">Mover</th>
                    <th style="width: 25%;">Nome</th>
                    <th style="width: 40%;">Descri√ß√£o</th>
                    <th style="width: 15%;">Valor (R$)</th>
                    <th class="delete-item-cell">Deletar</th> 
                </tr>
            </thead>
            <tbody>
                {% for produto in produtos %}
                <tr>
                    <td>
                        <div class="move-btn-container">
                            <a href="{{ url_for('move_item_action', category_key=categoria, item_index=loop.index0, direction='up') }}" class="move-link move-action">‚Üë</a>
                            <a href="{{ url_for('move_item_action', category_key=categoria, item_index=loop.index0, direction='down') }}" class="move-link move-action">‚Üì</a>
                        </div>
                    </td>
                    <td>
                        <input type="text" name="nome_{{ categoria }}" value="{{ produto.nome }}" required>
                    </td>
                    <td>
                        <input type="text" name="descricao_{{ categoria }}" value="{{ produto.descricao }}" required>
                    </td>
                    <td>
                        <input type="number" step="0.01" name="valor_{{ categoria }}" value="{{ '%.2f'|format(produto.valor) }}" required>
                    </td>
                    <td class="delete-item-cell">
                        <a href="{{ url_for('delete_item', category_key=categoria, item_index=loop.index0) }}" 
                           class="delete-btn delete-item-action"
                           data-item-name="{{ produto.nome }}"
                           data-category-name="{{ categoria | replace('_', ' ') | title }}">
                            X
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% endfor %} 
    </form>
    
    <div class="save-fixed-container">
        <button type="submit" class="main-save-btn" form="main-edit-form">Salvar Todas as Edi√ß√µes</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scrollKey = 'config_scroll_pos';
            const moveLinks = document.querySelectorAll('.move-action');
            const mainEditForm = document.getElementById('main-edit-form');
            const deleteCategoryLinks = document.querySelectorAll('.delete-category-action');
            const deleteItemLinks = document.querySelectorAll('.delete-item-action');
            
            // 1. ALERTA DE SUCESSO E LIMPEZA DA URL
            const urlParams = new URLSearchParams(window.location.search);
            const status = urlParams.get('status');

            if (status === 'saved') {
                alert("Configura√ß√µes salvas com sucesso!");
                history.replaceState(null, null, window.location.pathname);
            } else if (status === 'deleted') {
                alert("Item ou Categoria exclu√≠da com sucesso!");
                history.replaceState(null, null, window.location.pathname);
            }
            
            // 2. RESTAURAR SCROLL
            const savedScrollY = localStorage.getItem(scrollKey);
            if (savedScrollY) {
                window.scrollTo(0, parseInt(savedScrollY));
                localStorage.removeItem(scrollKey);
            }

            // FUN√á√ÉO AUXILIAR PARA SALVAR SCROLL
            function saveScrollPosition() {
                localStorage.setItem(scrollKey, window.scrollY);
            }

            // 3. SALVAR SCROLL ANTES DE SAIR COM MOVIMENTA√á√ÉO
            moveLinks.forEach(link => {
                link.addEventListener('click', saveScrollPosition);
            });

            // 4. SALVAR SCROLL ANTES DE SALVAR EDI√á√ïES
            if (mainEditForm) {
                mainEditForm.addEventListener('submit', saveScrollPosition);
            }

            // 5. CONFIRMA√á√ÉO DE DELETE E SALVAMENTO DE SCROLL

            // Confirma√ß√£o para Categoria
            deleteCategoryLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    const categoryName = this.getAttribute('data-category-name');
                    const confirmation = confirm(`ATEN√á√ÉO! Voc√™ tem certeza que deseja excluir a categoria "${categoryName}" e TODOS os seus itens?`);
                    
                    if (confirmation) {
                        saveScrollPosition(); // Salva o scroll antes de redirecionar para delete
                    } else {
                        event.preventDefault(); // Impede o clique se o usu√°rio cancelar
                    }
                });
            });

            // Confirma√ß√£o para Item
            deleteItemLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    const itemName = this.getAttribute('data-item-name');
                    const categoryName = this.getAttribute('data-category-name');
                    const confirmation = confirm(`Voc√™ tem certeza que deseja excluir o item "${itemName}" da categoria "${categoryName}"?`);
                    
                    if (confirmation) {
                        saveScrollPosition(); // Salva o scroll antes de redirecionar para delete
                    } else {
                        event.preventDefault(); // Impede o clique se o usu√°rio cancelar
                    }
                });
            });

            // 6. Limpeza (se o usu√°rio navegar para fora)
            const navLinks = document.querySelectorAll('.nav-links a');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    localStorage.removeItem(scrollKey);
                });
            });
        });
    </script>
</body>
</html>